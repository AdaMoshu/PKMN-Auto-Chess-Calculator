<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon Auto Chess Unit Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: black;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            display: flex;
            gap: 20px;
        }
        .form-container {
            flex: 1;
        }
        .graph-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-section {
            margin-top: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .result {
            font-size: 15px;
            margin-top: 20px;
            padding: 10px;
            color: white;
            background-color: transparent; 
            border: none;
            position: relative; 
            top: 0; 
            left: 0; 
        }
        input, select, button {
            margin-bottom: 10px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            background-color: #555;
            color: white;
            border: 1px solid #777;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            background-color: #444;
            border: 1px solid #666;
        }
        .hidden {
            display: none;
        }
        canvas {
            width: 100% !important;
            height: 400px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1>Pokémon Auto Chess Unit Calculator</h1>
            <form id="calculator-form">
                <label for="level">Level :</label>
                <select id="level">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>

                <label for="unitType">Unit Type :</label>
                <select id="unitType">
                    <option value="Common">Common</option>
                    <option value="Uncommon">Uncommon</option>
                    <option value="Rare">Rare</option>
                    <option value="Epic">Epic</option>
                    <option value="Ultra">Ultra</option>
                </select>

                <label for="includeAdditionals">Include Additionals :</label>
                <select id="includeAdditionals">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>

                <label for="starRating">Star Rating :</label>
                <select id="starRating">
                    <option value="2">2 Star</option>
                    <option value="3">3 Star</option>
                </select>

                <label for="bonusChance">Wild Chance :</label>
                <input type="number" id="bonusChance" step="1" value="0">

                <label for="rolls">Rolls :</label>
                <input type="number" id="rolls" value="0">

                <label for="regionalIn">Regional In :</label>
                <input type="number" id="regionalIn" value="0">

                <label for="regionalOut">Regional Out :</label>
                <input type="number" id="regionalOut" value="0">

                <label for="unitsOut">Units Out :</label>
                <input type="number" id="unitsOut" value="0">

                <label for="totalOut">Total Out :</label>
                <input type="number" id="totalOut" value="0">

                <div class="hidden">
                    <label for="unitPool">Unit Pool :</label>
                    <input type="number" id="unitPool" readonly>

                    <label for="totalPool">Total Pool :</label>
                    <input type="number" id="totalPool" readonly>
                </div>
            </form>
        </div>
        <div class="graph-container">
            <div class="chart-section">
                <div id="result" class="result"></div>
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        function updateResultPosition(top, left) {
            const resultElement = document.getElementById('result');
            resultElement.style.top = top + 'px';
            resultElement.style.left = left + 'px';
        }

        updateResultPosition(72, -30);
    </script>

    <script>
        const levelWeights = [
            { Common: 1, Uncommon: 0, Rare: 0, Epic: 0, Ultra: 0 },
            { Common: 1, Uncommon: 0, Rare: 0, Epic: 0, Ultra: 0 },
            { Common: 0.7, Uncommon: 0.3, Rare: 0, Epic: 0, Ultra: 0 },
            { Common: 0.55, Uncommon: 0.35, Rare: 0.1, Epic: 0, Ultra: 0 },
            { Common: 0.4, Uncommon: 0.38, Rare: 0.2, Epic: 0.02, Ultra: 0 },
            { Common: 0.25, Uncommon: 0.4, Rare: 0.3, Epic: 0.05, Ultra: 0 },
            { Common: 0.16, Uncommon: 0.33, Rare: 0.35, Epic: 0.15, Ultra: 0.01 },
            { Common: 0.11, Uncommon: 0.27, Rare: 0.35, Epic: 0.22, Ultra: 0.05 },
            { Common: 0.05, Uncommon: 0.2, Rare: 0.35, Epic: 0.3, Ultra: 0.1 }
        ];

        const poolTotals = [
            { Common: 587, Uncommon: 373, Rare: 315, Epic: 238, Ultra: 140 },
            { Common: 587, Uncommon: 477, Rare: 387, Epic: 294, Ultra: 140 }
        ];

        const unitCopies = [
            { Common: 18, Uncommon: 13, Rare: 9, Epic: 7, Ultra: 5 },
            { Common: 29, Uncommon: 22, Rare: 18, Epic: 14, Ultra: 10 }
        ];

        function updatePools() {
            const unitType = document.getElementById('unitType').value;
            const includeAdditionals = document.getElementById('includeAdditionals').value === 'true';
            const starRating = parseInt(document.getElementById('starRating').value);
            const poolIndex = includeAdditionals ? 1 : 0;
            const copiesIndex = starRating - 2;

            const unitPoolElement = document.getElementById('unitPool');
            const totalPoolElement = document.getElementById('totalPool');

            const unitPoolValue = unitCopies[copiesIndex][unitType] || 0;
            const totalPoolValue = poolTotals[poolIndex][unitType] || 0;

            unitPoolElement.value = unitPoolValue;
            totalPoolElement.value = totalPoolValue;

            calculateChance();
        }

        function calculateOneRollChance(weight, unitPool, unitsOut, totalPool, totalOut, regionalIn, regionalOut, bonusChance) {
            const Chance = weight + (bonusChance / 100);
            const effectivePool = unitPool - unitsOut;
            const effectiveRegionalPool = (unitPool * regionalIn) - regionalOut;
            const effectiveTotalPool = ((totalPool - totalOut) - unitsOut) - regionalOut;

            if (effectiveTotalPool <= 0) return 0;
            return (effectivePool / (effectiveTotalPool + effectiveRegionalPool)) * Chance;
        }

        function calculateMarkovChain(level, unitType, unitPool, totalPool, bonusChance, rolls, unitsOut, totalOut, regionalIn, regionalOut) {
            const weights = levelWeights[level - 1];
            const weight = weights[unitType] || 0;
            const oneRollChance = calculateOneRollChance(weight, unitPool, unitsOut, totalPool, totalOut, regionalIn, regionalOut, bonusChance);
            const probabilities = { success: [], failure: [] };

            for (let i = 0; i <= rolls; i++) {
                const notInOneSlot = 1 - oneRollChance;
                const notInAnySlots = Math.pow(notInOneSlot, 6); // 6 slots
                const unlucky = Math.pow(notInAnySlots, i); // No unit in i rolls
                const lucky = 1 - unlucky; // At least one unit in i rolls
                probabilities.success.push((lucky * 100).toFixed(2)); // Convert to percentage
                probabilities.failure.push((unlucky * 100).toFixed(2)); // Convert to percentage
            }

            return probabilities;
        }

        function calculateChance() {
            const level = parseInt(document.getElementById('level').value);
            const unitType = document.getElementById('unitType').value;
            const unitPool = parseFloat(document.getElementById('unitPool').value);
            const totalPool = parseFloat(document.getElementById('totalPool').value);
            const bonusChance = parseFloat(document.getElementById('bonusChance').value);
            const rolls = parseInt(document.getElementById('rolls').value);
            const unitsOut = parseInt(document.getElementById('unitsOut').value);
            const totalOut = parseInt(document.getElementById('totalOut').value);
            const regionalIn = parseInt(document.getElementById('regionalIn').value);
            const regionalOut = parseInt(document.getElementById('regionalOut').value);

            if (isNaN(unitPool) || isNaN(totalPool) || isNaN(bonusChance) || isNaN(rolls) || isNaN(unitsOut) || isNaN(totalOut) || isNaN(regionalIn) || isNaN(regionalOut)) {
                document.getElementById('result').innerHTML = 'Invalid input values';
                return;
            }

            const markovChainProbabilities = calculateMarkovChain(level, unitType, unitPool, totalPool, bonusChance, rolls, unitsOut, totalOut, regionalIn, regionalOut);
            const mostRecentSuccess = markovChainProbabilities.success[markovChainProbabilities.success.length - 1];
            const mostRecentFailure = markovChainProbabilities.failure[markovChainProbabilities.failure.length - 1];
            document.getElementById('result').innerHTML = 
               `<pre>
                ${mostRecentSuccess}%           ${mostRecentFailure}%
                </pre>`;

            updateChart(markovChainProbabilities);
        }

        let chart;

        function updateChart(probabilities) {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) {
                chart.destroy(); // Destroy the previous chart instance
            }
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({ length: probabilities.success.length }, (_, i) => `${i}`),
                    datasets: [
                        {
                            label: 'Hit                ',
                            data: probabilities.success,
                            backgroundColor: '#36A2EB',
                            borderColor: '#36A2EB',
                            borderWidth: 1
                        },
                        {
                            label: 'Miss                ',
                            data: probabilities.failure,
                            backgroundColor: '#FF6384',
                            borderColor: '#FF6384',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Rolls',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Chance (%)',
                                color: 'white'
                            },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10,
                                color: 'white'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.formattedValue}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function setupEventListeners() {
            const inputs = ['level', 'unitType', 'includeAdditionals', 'starRating', 'bonusChance', 'rolls', 'unitsOut', 'totalOut', 'regionalIn', 'regionalOut'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    updatePools(); // Update hidden pool values before calculation
                });
            });
        }

        setupEventListeners();
        updatePools(); // Initial pool values and calculation
    </script>
</body>
</html>

